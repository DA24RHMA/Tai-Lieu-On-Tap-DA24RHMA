<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study Zone</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/theme_galaxy.css" />
    <link rel="stylesheet" href="styles/theme_cat.css" />
    <style>
      /* --- LOCAL STYLES (UPDATED FOR SIZE) --- */
      #study-wrapper {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        background: radial-gradient(
          circle at center,
          #1b1b2f,
          #0f0c29
        ); /* Th√™m n·ªÅn m·∫∑c ƒë·ªãnh cho ƒë·∫πp */
      }
      .study-header {
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.2); /* Gi·∫£m ƒë·ªô t·ªëi ƒë·ªÉ tho√°ng h∆°n */
        backdrop-filter: blur(10px); /* Th√™m blur cho header */
        z-index: 90;
        height: 80px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .back-btn {
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-color);
        font-size: 1rem;
        padding: 8px 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 30px;
        transition: 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .back-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(-5px);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      }
      .avatar-btn {
        z-index: 9999 !important;
        touch-action: none;
      }
      .profile-header {
        cursor: default;
      }
      .modal-drag-header {
        cursor: move;
      }

      /* QUEST ITEM STYLE */
      .quest-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 15px;
        margin-bottom: 5px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
      }
      .quest-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      .quest-done {
        color: #2ecc71;
        text-decoration: line-through;
        opacity: 0.6;
      }
      .quest-done span:last-child {
        text-decoration: none;
        font-weight: bold;
      }

      /* SCREEN LOGIC */
      .screen {
        flex: 1;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        width: 100%;
      }
      .screen.active {
        display: flex;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* --- DECK SELECT (GRID) - INCREASED SIZE --- */
      .deck-list {
        width: 95%;
        max-width: 1200px;
        max-height: 80vh;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(220px, 1fr)
        ); /* R·ªông h∆°n ch√∫t */
        gap: 25px;
        padding: 20px; /* Th√™m padding ƒë·ªÉ kh√¥ng b·ªã c·∫Øt b√≥ng ƒë·ªï */
        background: transparent;
        border: none;
        scrollbar-width: none; /* ·∫®n thanh cu·ªôn */
      }
      .deck-list::-webkit-scrollbar {
        display: none;
      }

      .deck-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 25px;
        padding: 30px 20px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 160px;
        position: relative;
        backdrop-filter: blur(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .deck-item:hover {
        transform: translateY(-8px);
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
      }
      .deck-item.selected {
        border-color: var(--accent-color);
        background: rgba(0, 210, 255, 0.1);
        box-shadow: 0 0 25px rgba(0, 210, 255, 0.25);
      }
      .deck-item.selected::after {
        content: "\f00c"; /* FontAwesome check */
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        top: 15px;
        right: 15px;
        background: var(--accent-color);
        color: #000;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 10px var(--accent-color);
      }
      .deck-title-text {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 10px;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }
      .deck-info-text {
        font-size: 0.9rem;
        color: #ccc;
        background: rgba(0, 0, 0, 0.3);
        padding: 4px 12px;
        border-radius: 12px;
      }

      /* --- DATA MANAGER DECORATION --- */
      .dm-container {
        width: 95%;
        max-width: 1300px;
        height: 85vh;
        background: rgba(20, 20, 35, 0.85); /* N·ªÅn t·ªëi h∆°n ch√∫t */
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        backdrop-filter: blur(20px); /* Blur m·∫°nh h∆°n */
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      }
      .dm-tabs {
        display: flex;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(0, 0, 0, 0.2);
        padding: 10px 20px;
        gap: 15px;
      }
      .dm-tab {
        padding: 12px 25px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
        background: transparent;
        color: #888;
        border-radius: 15px;
        border: 1px solid transparent;
      }
      .dm-tab:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.05);
      }
      .dm-tab.active {
        background: rgba(0, 210, 255, 0.15);
        color: var(--accent-color);
        border-color: rgba(0, 210, 255, 0.3);
        box-shadow: 0 0 15px rgba(0, 210, 255, 0.1);
      }
      .dm-body {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        position: relative;
      }
      /* Custom scrollbar cho DM */
      .dm-body::-webkit-scrollbar {
        width: 8px;
      }
      .dm-body::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .dm-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 25px;
      }
      .dm-deck-card {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.02)
        );
        border-radius: 20px;
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: 0.3s;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .dm-deck-card:hover {
        border-color: var(--accent-color);
        transform: translateY(-8px);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      }
      .dm-deck-count {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--accent-color);
        text-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
      }
      .dm-deck-title {
        font-size: 1rem;
        margin-top: 15px;
        color: #ddd;
        font-weight: 600;
      }
      .dm-list-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 25px;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .dm-back-btn {
        padding: 8px 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: 0.2s;
        font-size: 0.9rem;
        color: #ccc;
      }
      .dm-back-btn:hover {
        background: var(--accent-color);
        color: #000;
      }

      /* DM List Items Decoration */
      .dm-card-item {
        background: rgba(255, 255, 255, 0.03);
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-left: 4px solid transparent;
        transition: 0.2s;
      }
      .dm-card-item:hover {
        background: rgba(255, 255, 255, 0.06);
        transform: translateX(5px);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .dm-card-item.hidden-card {
        opacity: 0.6;
        border-left-color: #e74c3c;
        background: rgba(231, 76, 60, 0.05);
      }
      .dm-card-item.edited-card {
        border-left-color: #f1c40f;
        background: rgba(241, 196, 15, 0.05);
      }
      .dm-card-actions {
        display: flex;
        gap: 12px;
      }
      .dm-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 12px; /* H√¨nh vu√¥ng bo g√≥c thay v√¨ tr√≤n */
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: 0.2s;
        color: #fff;
        font-size: 1rem;
      }
      .dm-action-btn:hover {
        transform: scale(1.1);
        filter: brightness(1.2);
      }
      .btn-hide {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.3);
      }
      .btn-reset {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
      }
      .btn-edit {
        background: rgba(241, 196, 15, 0.2);
        color: #f1c40f;
        border: 1px solid rgba(241, 196, 15, 0.3);
      }
      .btn-restore {
        background: rgba(46, 204, 113, 0.2);
        color: #2ecc71;
        border: 1px solid rgba(46, 204, 113, 0.3);
      }

      /* --- STUDY SCREEN DECORATION (Quan tr·ªçng nh·∫•t) --- */
      .fsrs-controls {
        display: flex;
        gap: 20px; /* TƒÉng kho·∫£ng c√°ch */
        justify-content: center;
        margin-top: 40px;
        width: 100%;
        flex-wrap: nowrap; /* Kh√¥ng xu·ªëng d√≤ng */
      }
      .rate-btn {
        flex: 1;
        min-width: 90px;
        height: 80px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh */
        padding: 10px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        opacity: 0.9;
      }
      .rate-btn:hover {
        transform: translateY(-5px) scale(1.05);
        filter: brightness(1.2);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        opacity: 1;
      }
      .rate-btn:active {
        transform: translateY(2px);
      }
      .rb-label {
        font-weight: 800;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .rb-time {
        font-size: 0.85rem;
        background: rgba(0, 0, 0, 0.3);
        padding: 3px 10px;
        border-radius: 10px;
        min-width: 50px;
      }
      /* Gradient ƒë·∫πp h∆°n cho n√∫t */
      .btn-again {
        background: linear-gradient(135deg, #ff4757, #ff6b81);
        box-shadow: 0 10px 20px rgba(255, 71, 87, 0.4);
      }
      .btn-hard {
        background: linear-gradient(135deg, #ffa502, #ffc048);
        box-shadow: 0 10px 20px rgba(255, 165, 2, 0.4);
      }
      .btn-good {
        background: linear-gradient(135deg, #2ed573, #7bed9f);
        box-shadow: 0 10px 20px rgba(46, 213, 115, 0.4);
      }
      .btn-easy {
        background: linear-gradient(135deg, #1e90ff, #70a1ff);
        box-shadow: 0 10px 20px rgba(30, 144, 255, 0.4);
      }

      /* --- CARD CONTENT FIX & DECORATION --- */
      .card-container {
        width: 100%;
        max-width: 950px; /* R·ªông h∆°n */
        min-height: 550px;
        background: linear-gradient(
          160deg,
          rgba(35, 35, 55, 0.9),
          rgba(20, 20, 30, 0.95)
        ); /* Gradient n·ªÅn th·∫ª */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 35px;
        padding: 60px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7); /* B√≥ng ƒë·ªï s√¢u */
        backdrop-filter: blur(25px);
      }

      /* Vi·ªÅn s√°ng trang tr√≠ cho th·∫ª */
      .card-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.5),
          transparent
        );
      }

      .card-content {
        font-size: 1.8rem; /* Ch·ªØ to h∆°n */
        line-height: 1.6;
        text-align: center;
        margin-bottom: 40px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 10px;
        word-wrap: break-word;
      }

      .card-content #q-text,
      .card-content #q-answer-area {
        text-align: left;
        line-height: 1.6;
        font-size: 1.3rem;
        margin: 0 auto;
        max-width: 100%;
        padding: 0 10px;
      }

      /* C√¢u h·ªèi n·ªïi b·∫≠t h∆°n */
      .card-content #q-text {
        color: #fff;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      }

      /* Importer Styles (Gi·ªØ nguy√™n nh∆∞ng tinh ch·ªânh) */
      .card-content .question-main {
        margin-bottom: 30px !important;
        font-size: 1.4em !important;
        font-weight: 800 !important;
        color: var(--accent-color);
        display: block;
        text-transform: none; /* Kh√¥ng √©p vi·∫øt hoa */
      }
      .card-content .answer-correct {
        color: #2ecc71;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 15px;
        background: rgba(46, 204, 113, 0.1);
        display: inline-block;
        padding: 5px 15px;
        border-radius: 10px;
        border: 1px solid rgba(46, 204, 113, 0.3);
      }
      .card-content .answer-explanation {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 20px;
        margin-top: 20px;
        font-size: 1.1rem;
        color: #ccc;
        font-style: italic;
      }

      .card-question {
        font-weight: bold;
        margin-bottom: 30px;
      }
      .card-answer-area {
        border-top: 2px dashed rgba(255, 255, 255, 0.1); /* N√©t ƒë·ª©t */
        padding-top: 30px;
        margin-top: 30px;
        display: none;
        text-align: left;
        animation: slideDown 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .edit-card-btn {
        position: absolute;
        top: 25px;
        right: 25px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        color: #aaa;
        cursor: pointer;
        font-size: 1.2rem;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .edit-card-btn:hover {
        color: var(--accent-color);
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(15deg);
      }

      /* Settings Panel */
      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .settings-body {
        padding: 20px;
        display: none;
      }
      .settings-body.active {
        display: block;
      }
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .profile-view {
        display: block;
      }
      .profile-view.hidden {
        display: none !important;
      }

      /* Responsive adjustments for smaller screens */
      @media (max-width: 768px) {
        .card-container {
          padding: 30px 20px;
          min-height: 450px;
          max-width: 100%;
          border-radius: 25px;
        }
        .card-content {
          font-size: 1.4rem;
        }
        .card-content #q-text,
        .card-content #q-answer-area {
          font-size: 1.1rem;
          padding: 0;
        }
        .card-content .question-main {
          font-size: 1.2em !important;
        }
        .deck-list {
          max-width: 100%;
          max-height: 80vh;
          grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
          gap: 15px;
        }
        .dm-container {
          height: 100vh;
          width: 100%;
          border-radius: 0;
          max-width: 100%;
          border: none;
        }
        .fsrs-controls {
          gap: 10px;
        }
        .rate-btn {
          min-width: 70px;
          height: 70px;
        }
        .rb-label {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body data-theme="galaxy">
    <div
      class="galaxy-intro-element"
      id="galaxy-bg-layer"
      style="position: fixed; width: 100%; height: 100%; z-index: -1"
    >
      <div class="static-stars"></div>
    </div>
    <div class="cat-bg-pattern cat-intro-element"></div>

    <!-- AVATAR BUTTON -->
    <div class="avatar-btn" id="floating-avatar" style="top: 90px">
      <span id="user-avt">üë®‚ÄçüöÄ</span>
      <div class="avatar-badge" id="lvl-badge">1</div>
    </div>

    <!-- PROFILE MODAL -->
    <div class="modal-overlay" id="profile-modal">
      <div class="profile-modal-content" id="profile-content">
        <div class="profile-header">
          <div class="profile-user">
            <div class="profile-avt-large" id="modal-avt">üë®‚ÄçüöÄ</div>
            <div>
              <div style="font-weight: bold; font-size: 1.5rem">H·ªçc Vi√™n</div>
              <div
                class="profile-stats-row"
                style="font-size: 0.9rem; margin-top: 5px"
              >
                <span id="profile-lvl-txt" class="lvl-badge-mini">LV.1</span>
                <i
                  class="fas fa-fire"
                  style="color: orange; margin-left: 5px"
                ></i>
                <b id="p-streak">0</b>
                <i
                  class="fas fa-coins"
                  style="color: gold; margin-left: 10px"
                ></i>
                <b id="p-coins">0</b>
                <i
                  class="fas fa-seedling"
                  style="color: #4caf50; margin-left: 10px"
                ></i>
                <b id="p-seeds">0</b>
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 10px">
            <button
              class="btn-secondary"
              onclick="toggleSettingsView()"
              title="C√†i ƒë·∫∑t"
              style="position: relative; z-index: 100"
            >
              <i class="fas fa-cog"></i>
            </button>
            <button
              class="btn-secondary"
              onclick="closeProfile()"
              style="position: relative; z-index: 100"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="profile-body profile-view" id="view-stats">
          <div class="dash-widget">
            <div class="dw-title">
              <i class="fas fa-scroll"></i> Nhi·ªám V·ª• H√¥m Nay
            </div>
            <div id="quest-list"></div>
            <div style="margin-top: 10px; font-size: 0.9rem; color: #aaa">
              ƒê√£ h·ªçc h√¥m nay: <b id="today-count" style="color: #fff">0</b> th·∫ª
            </div>
          </div>
          <div class="dash-widget">
            <div class="dw-title"><i class="fas fa-clock"></i> Pomodoro</div>
            <div
              class="pomo-display"
              id="pomo-timer"
              style="
                font-size: 3rem;
                text-align: center;
                font-weight: bold;
                margin: 10px 0;
              "
            >
              25:00
            </div>
            <div class="ios-picker-wrapper" id="pomo-picker-ui">
              <div class="picker-col" id="pomo-min-scroll">
                <div class="picker-pad"></div>
              </div>
              <span style="font-weight: bold; font-size: 1.5rem">:</span>
              <div class="picker-col" id="pomo-sec-scroll">
                <div class="picker-pad"></div>
              </div>
            </div>
            <div
              style="
                text-align: center;
                gap: 10px;
                display: flex;
                justify-content: center;
              "
            >
              <button
                class="btn-primary"
                id="pomo-toggle"
                onclick="togglePomo()"
              >
                B·∫Øt ƒë·∫ßu
              </button>
              <button class="btn-secondary" onclick="resetPomo()">
                <i class="fas fa-redo"></i>
              </button>
            </div>
          </div>
          <div class="game-center">
            <div
              class="game-card"
              onclick="alert('Game Nu√¥i Pet ƒëang ph√°t tri·ªÉn!')"
            >
              <div class="gc-icon">üê±</div>
              <div><b>Nu√¥i Pet</b></div>
            </div>
            <div
              class="game-card"
              onclick="alert('Game Tr·ªìng R·ª´ng: ' + (window.UserDB ? window.UserDB.data.forest.seeds : 0) + ' m·∫ßm!')"
            >
              <div class="gc-icon">üå≤</div>
              <div><b>Tr·ªìng R·ª´ng</b></div>
            </div>
          </div>
        </div>

        <div
          class="profile-body profile-view hidden"
          id="view-settings"
          style="display: none"
        >
          <h2 style="margin-bottom: 20px; color: var(--accent-color)">
            C√†i ƒê·∫∑t H·ªá Th·ªëng
          </h2>
          <div class="setting-row">
            <span>Giao di·ªán (Theme)</span>
            <select
              id="theme-select"
              class="dm-select"
              style="width: 150px"
              onchange="changeTheme(this.value)"
            >
              <option value="galaxy">Galaxy (T·ªëi)</option>
              <option value="cat">Meow (S√°ng)</option>
            </select>
          </div>
          <div class="setting-row">
            <span>D·ªØ li·ªáu h·ªçc t·∫≠p</span>
            <button
              class="btn-hide"
              onclick="confirmResetData()"
              style="
                padding: 10px 20px;
                background: #e74c3c;
                border: none;
                border-radius: 5px;
                color: white;
                cursor: pointer;
              "
            >
              <i class="fas fa-trash"></i> Reset To√†n B·ªô
            </button>
          </div>
          <p style="color: #aaa; font-size: 0.9rem; margin-top: 20px">
            Phi√™n b·∫£n: 1.5.1 (HTML Fix) <br />
            Reset s·∫Ω x√≥a to√†n b·ªô ti·∫øn ƒë·ªô, xu v√† c√†i ƒë·∫∑t v·ªÅ m·∫∑c ƒë·ªãnh.
          </p>
        </div>
      </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal-overlay" id="edit-modal">
      <div class="edit-modal-content" id="edit-content">
        <div class="modal-drag-header" id="edit-header-drag">
          <span
            style="
              font-weight: bold;
              font-size: 1.2rem;
              color: var(--accent-color);
            "
            ><i class="fas fa-edit"></i> Ch·ªânh S·ª≠a Th·∫ª</span
          >
          <button
            style="
              background: none;
              border: none;
              color: #fff;
              font-size: 1.2rem;
              cursor: pointer;
            "
            onclick="closeEditModal()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="form-container">
          <div class="form-group">
            <label>C√¢u h·ªèi</label><textarea id="edit-q" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>ƒê√°p √°n / Gi·∫£i th√≠ch</label
            ><textarea id="edit-a" rows="4"></textarea>
          </div>
          <div
            style="
              display: flex;
              justify-content: flex-end;
              gap: 10px;
              margin-top: 10px;
            "
          >
            <button class="btn-secondary" onclick="closeEditModal()">
              H·ªßy
            </button>
            <button class="btn-primary" onclick="saveCardEdit()">
              L∆∞u Thay ƒê·ªïi
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="study-wrapper">
      <div class="study-header">
        <div class="back-btn" onclick="handleBack()">
          <i class="fas fa-arrow-left"></i> Tr·ªü v·ªÅ
        </div>
        <div id="subject-title" style="font-weight: bold; font-size: 1.5rem">
          K√Ω Sinh Tr√πng
        </div>
        <div style="width: 80px"></div>
      </div>

      <!-- DASHBOARD -->
      <div id="screen-dashboard" class="screen active">
        <div class="dashboard-actions">
          <div class="action-card" onclick="goToDeckSelect()">
            <div class="ac-icon">üìù</div>
            <span class="ac-title">V√†o H·ªçc</span>
          </div>
          <div class="action-card" onclick="openDataManager()">
            <div class="ac-icon">üóÇÔ∏è</div>
            <span class="ac-title">Kho D·ªØ Li·ªáu</span>
          </div>
        </div>
      </div>

      <!-- DECK SELECT (GRID) -->
      <div id="screen-deck-select" class="screen">
        <h2 style="margin-bottom: 20px">Ch·ªçn ƒê·ªÅ ƒê·ªÉ H·ªçc</h2>
        <div class="deck-list" id="deck-list-container"></div>
        <div style="display: flex; gap: 20px; margin-top: 20px">
          <button
            class="btn-secondary"
            onclick="showScreen('screen-dashboard')"
          >
            Quay l·∫°i
          </button>
          <button class="btn-primary" onclick="startSession()">
            üöÄ B·∫Øt ƒê·∫ßu
          </button>
        </div>
      </div>

      <div id="screen-study" class="screen">
        <div class="card-container">
          <button
            class="edit-card-btn"
            onclick="openEditModalForCurrent()"
            title="S·ª≠a"
          >
            <i class="fas fa-pen"></i>
          </button>
          <div class="card-content">
            <div class="card-question" id="q-text">...</div>
            <div class="card-answer-area" id="q-answer-area"></div>
          </div>
          <div id="controls-area"></div>
        </div>
        <button
          class="btn-secondary"
          style="margin-top: 20px"
          onclick="showScreen('screen-dashboard')"
        >
          Tho√°t
        </button>
      </div>

      <div id="screen-data-manager" class="screen">
        <div class="dm-container">
          <div class="dm-tabs">
            <div class="dm-tab active" onclick="switchDMTab('decks')">
              üìÅ Kho B√†i
            </div>
            <div class="dm-tab" onclick="switchDMTab('trash')">
              üóëÔ∏è Th√πng R√°c / ƒê√£ S·ª≠a
            </div>
          </div>
          <div class="dm-body" id="dm-view-decks">
            <div id="dm-grid-container" class="dm-grid"></div>
            <div id="dm-list-container" style="display: none">
              <div class="dm-list-header">
                <div class="dm-back-btn" onclick="showDeckGrid()">
                  <i class="fas fa-arrow-left"></i> Quay l·∫°i
                </div>
                <h3 id="dm-current-deck-title">T√™n ƒê·ªÅ</h3>
              </div>
              <div id="dm-card-list"></div>
            </div>
          </div>
          <div class="dm-body" id="dm-view-trash" style="display: none">
            <p style="color: #aaa; margin-bottom: 15px">
              Danh s√°ch c√°c th·∫ª ƒë√£ ·∫©n ho·∫∑c ƒë√£ ch·ªânh s·ª≠a n·ªôi dung.
            </p>
            <div id="dm-trash-list"></div>
          </div>
        </div>
        <button
          class="btn-secondary"
          style="margin-top: 20px"
          onclick="showScreen('screen-dashboard')"
        >
          ƒê√≥ng
        </button>
      </div>
    </div>

    <script src="core/fsrs.js"></script>
    <script src="core/importer.js"></script>
    <script src="core/database.js"></script>
    <script src="data/subjects.js"></script>
    <script>
      const savedTheme = localStorage.getItem("app_theme") || "galaxy";
      document.body.setAttribute("data-theme", savedTheme);
      const subjectCode = "KST";
      const POMO_STATE_KEY = "DA24RHMA_POMO_STATE";

      let availableDecks = [];
      let currentSessionCards = [];
      let currentCardIndex = 0;
      let currentCard = null;
      let cardToEdit = null;
      let currentPage = 1;
      const itemsPerPage = 50;
      let currentFilteredCards = [];

      window.onload = async () => {
        if (typeof window.UserDB === "undefined") alert("L·ªói Database!");
        loadPomoState();
        updateAvatar();
        if (window.SubjectConfig) {
          await autoLoadDecks();
          mergeCardOverrides();
        }
        if (savedTheme === "galaxy") startGalaxyAnim();
        makeDraggable(
          document.getElementById("edit-content"),
          document.getElementById("edit-header-drag")
        );
        initFloatingAvatar();
        initIOSPickers();
        if (document.getElementById("theme-select"))
          document.getElementById("theme-select").value = savedTheme;
        document.addEventListener("keydown", handleHotkeys);
      };

      function formatFSRSTime(days) {
        if (days === 0 || days < 0.0035) return "1m";
        if (days < 1) {
          const min = Math.round(days * 24 * 60);
          if (min < 60) return min + "m";
          return Math.round(days * 24) + "h";
        }
        if (days < 30) return Math.round(days) + "d";
        if (days < 365) return Math.round(days / 30) + "mo";
        return Math.round(days / 365) + "y";
      }

      function getFSRSPreview(card, grade) {
        const tempCard = { ...card };
        if (card.fsrs) {
          tempCard.fsrs = { ...card.fsrs };
        }
        const result = window.FSRSAlgorithm.schedule(tempCard.fsrs, grade);
        return formatFSRSTime(result.interval);
      }

      function updateAvatar() {
        const icon = savedTheme === "cat" ? "üê±" : "üë®‚ÄçüöÄ";
        document.getElementById("user-avt").innerText = icon;
        document.getElementById("modal-avt").innerText = icon;
        if (window.UserDB)
          document.getElementById("lvl-badge").innerText =
            window.UserDB.getStreakLevel();
      }

      function renderDecks() {
        const c = document.getElementById("deck-list-container");
        if (!c) return;
        c.innerHTML = "";
        availableDecks.forEach((d, i) => {
          const count = d.cards.filter((c) => !c.isHidden).length;
          const el = document.createElement("div");
          el.className = "deck-item";
          el.dataset.index = i;
          el.onclick = () => {
            el.classList.toggle("selected");
          };
          el.innerHTML = `
                <div style="font-size: 2.5rem; margin-bottom: 10px;">üìö</div>
                <div class="deck-title-text">${d.title}</div>
                <div class="deck-info-text">${count} th·∫ª</div>
            `;
          c.appendChild(el);
        });
      }

      function startSession() {
        const selectedEls = document.querySelectorAll(
          "#deck-list-container .deck-item.selected"
        );
        if (selectedEls.length == 0) return alert("H√£y ch·ªçn √≠t nh·∫•t 1 ƒë·ªÅ!");
        currentSessionCards = [];
        selectedEls.forEach((el) => {
          const idx = el.dataset.index;
          const activeCards = availableDecks[idx].cards.filter(
            (c) => !c.isHidden
          );
          currentSessionCards = currentSessionCards.concat(activeCards);
        });
        if (currentSessionCards.length === 0)
          return alert("Kh√¥ng c√≥ th·∫ª n√†o kh·∫£ d·ª•ng!");
        currentSessionCards.sort(() => Math.random() - 0.5);
        currentCardIndex = 0;
        showScreen("screen-study");
        loadCard(currentSessionCards[0]);
      }

      function makeDraggable(elmnt, handle) {
        if (!elmnt || !handle) return;
        let pos1 = 0,
          pos2 = 0,
          pos3 = 0,
          pos4 = 0;
        handle.onmousedown = dragMouseDown;
        function dragMouseDown(e) {
          e = e || window.event;
          if (
            e.target.tagName === "BUTTON" ||
            e.target.closest("button") ||
            e.target.tagName === "SELECT" ||
            e.target.closest("select")
          )
            return;
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }
        function elementDrag(e) {
          e = e || window.event;
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          elmnt.style.top = elmnt.offsetTop - pos2 + "px";
          elmnt.style.left = elmnt.offsetLeft - pos1 + "px";
        }
        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }

      function updateProfileUI() {
        if (!window.UserDB) return;
        const db = window.UserDB.data;
        const setTxt = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.innerText = val;
        };
        setTxt("p-streak", db.streak);
        setTxt("p-coins", db.coins);
        setTxt("p-seeds", db.forest.seeds);
        setTxt("today-count", db.quests.cardsLearnedToday);
        setTxt("profile-lvl-txt", "LV." + window.UserDB.getStreakLevel());
        const qList = document.getElementById("quest-list");
        if (qList) {
          qList.innerHTML = "";
          const quests = [
            { t: "H·ªçc 30 th·∫ª", done: db.quests.q30 },
            { t: "H·ªçc 50 th·∫ª", done: db.quests.q50 },
            { t: "H·ªçc 100 th·∫ª", done: db.quests.q100 },
            { t: "Ho√†n th√†nh 1 Pomodoro", done: db.quests.pomo },
          ];
          quests.forEach((q) => {
            qList.innerHTML += `<div class="quest-item ${
              q.done ? "quest-done" : ""
            }"><span>${q.t}</span><span>${
              q.done ? "‚úÖ" : "+1 Xu"
            }</span></div>`;
          });
        }
        updatePomoDisplay();
        updatePickerPosition();
        const btn = document.getElementById("pomo-toggle");
        if (isRunning) {
          btn.innerText = "T·∫°m d·ª´ng";
          document.getElementById("pomo-picker-ui").style.pointerEvents =
            "none";
          document.getElementById("pomo-picker-ui").style.opacity = "0.5";
        } else {
          if (timeLeft < db.pomodoro.workTime && timeLeft > 0) {
            btn.innerText = "Ti·∫øp t·ª•c";
          } else {
            btn.innerText = "B·∫Øt ƒë·∫ßu";
          }
          document.getElementById("pomo-picker-ui").style.pointerEvents =
            "auto";
          document.getElementById("pomo-picker-ui").style.opacity = "1";
        }
      }

      function openProfile() {
        document.getElementById("view-stats").classList.remove("hidden");
        document.getElementById("view-settings").classList.add("hidden");
        document.getElementById("view-stats").style.display = "grid";
        document.getElementById("view-settings").style.display = "none";
        updateProfileUI();
        document.getElementById("profile-modal").classList.add("modal-active");
      }
      function closeProfile() {
        document
          .getElementById("profile-modal")
          .classList.remove("modal-active");
      }
      function handleBack() {
        window.location.href = "index.html";
      }
      function showScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
      }
      async function autoLoadDecks() {
        const config = window.SubjectConfig[subjectCode];
        availableDecks = [];
        for (const f of config.files) {
          try {
            const res = await fetch(`${config.folder}/${f}`);
            if (res.ok)
              availableDecks.push(Importer.parse(await res.text(), f));
          } catch (e) {}
        }
        renderDecks();
        mergeCardOverrides();
      }
      function goToDeckSelect() {
        showScreen("screen-deck-select");
      }

      /* --- LOAD CARD (FIXED: USING INNERHTML) --- */
      function loadCard(c) {
        currentCard = c;
        document.getElementById("q-text").innerHTML = c.question; // QUAN TR·ªåNG: D√πng innerHTML ƒë·ªÉ hi·ªÉn th·ªã m√£ HTML
        document.getElementById("q-answer-area").innerHTML = "";
        document.getElementById("q-answer-area").style.display = "none";

        const ctrl = document.getElementById("controls-area");
        ctrl.innerHTML = "";

        const b = document.createElement("button");
        b.className = "btn-primary";
        b.style.width = "100%";
        b.innerText = "Hi·ªán (Space)";
        b.onclick = () => {
          reveal();
          const t1 = getFSRSPreview(c, 1);
          const t2 = getFSRSPreview(c, 2);
          const t3 = getFSRSPreview(c, 3);
          const t4 = getFSRSPreview(c, 4);
          ctrl.innerHTML = `
            <div class="fsrs-controls">
                <button class="rate-btn btn-again" onclick="rate(1)"><span class="rb-label">Again</span><span class="rb-time">${t1}</span></button>
                <button class="rate-btn btn-hard" onclick="rate(2)"><span class="rb-label">Hard</span><span class="rb-time">${t2}</span></button>
                <button class="rate-btn btn-good" onclick="rate(3)"><span class="rb-label">Good</span><span class="rb-time">${t3}</span></button>
                <button class="rate-btn btn-easy" onclick="rate(4)"><span class="rb-label">Easy</span><span class="rb-time">${t4}</span></button>
            </div>`;
        };
        ctrl.appendChild(b);
      }

      function reveal() {
        const a = document.getElementById("q-answer-area");
        a.style.display = "block";
        a.innerHTML = currentCard.answer; // QUAN TR·ªåNG: D√πng innerHTML
      }

      function rate(grade) {
        if (currentCard) {
          const newFsrs = window.FSRSAlgorithm.schedule(
            currentCard.fsrs,
            grade
          );
          currentCard.fsrs = newFsrs;
          if (window.UserDB) {
            window.UserDB.saveCardOverride(currentCard.id, { fsrs: newFsrs });
            window.UserDB.incrementCardCount();
          }
          if (grade === 1) {
            const insertPos = Math.min(
              currentSessionCards.length,
              currentCardIndex + 3 + Math.floor(Math.random() * 3)
            );
            currentSessionCards.splice(insertPos, 0, currentCard);
          }
        }
        nextCard();
      }

      function nextCard() {
        currentCardIndex++;
        if (currentCardIndex < currentSessionCards.length)
          loadCard(currentSessionCards[currentCardIndex]);
        else {
          alert("H·∫øt b√†i!");
          showScreen("screen-dashboard");
        }
      }
      function handleHotkeys(e) {
        if (document.getElementById("edit-modal").style.display === "flex")
          return;
        if (
          !document.getElementById("screen-study").classList.contains("active")
        )
          return;
        const key = e.key;
        const answerVisible =
          document.getElementById("q-answer-area").style.display === "block";
        if (!answerVisible && (key === " " || key === "Enter")) {
          document.querySelector("#controls-area button").click();
        } else if (answerVisible && ["1", "2", "3", "4"].includes(key)) {
          rate(parseInt(key));
        }
      }

      function mergeCardOverrides() {
        if (!window.UserDB) return;
        availableDecks.forEach((deck) => {
          deck.cards.forEach((card) => {
            const override = window.UserDB.getCardOverride(card.id);
            if (override) {
              if (override.question) card.question = override.question;
              if (override.explanation) card.explanation = override.explanation;
              if (override.answer) card.answer = override.answer;
              card.isHidden = override.isHidden || false;
              if (override.fsrs) card.fsrs = override.fsrs;
            }
          });
        });
      }
      function openDataManager() {
        showScreen("screen-data-manager");
        switchDMTab("decks");
        showDeckGrid();
      }
      function switchDMTab(tabName) {
        document
          .querySelectorAll(".dm-tab")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");
        if (tabName === "decks") {
          document.getElementById("dm-view-decks").style.display = "block";
          document.getElementById("dm-view-trash").style.display = "none";
          showDeckGrid();
        } else {
          document.getElementById("dm-view-decks").style.display = "none";
          document.getElementById("dm-view-trash").style.display = "block";
          renderTrashBin();
        }
      }
      function showDeckGrid() {
        document.getElementById("dm-grid-container").style.display = "grid";
        document.getElementById("dm-list-container").style.display = "none";
        const container = document.getElementById("dm-grid-container");
        container.innerHTML = "";
        availableDecks.forEach((deck, idx) => {
          const activeCount = deck.cards.filter((c) => !c.isHidden).length;
          const totalCount = deck.cards.length;
          const div = document.createElement("div");
          div.className = "dm-deck-card";
          div.innerHTML = `<div class="dm-deck-count">${activeCount}</div><div class="dm-deck-title">${deck.title}</div><div style="font-size:0.8rem; color:#666;">/${totalCount} th·∫ª</div>`;
          div.onclick = () => showDeckList(idx);
          container.appendChild(div);
        });
      }
      let currentDMDeckIdx = -1;
      function showDeckList(deckIdx) {
        currentDMDeckIdx = deckIdx;
        document.getElementById("dm-grid-container").style.display = "none";
        document.getElementById("dm-list-container").style.display = "block";
        const deck = availableDecks[deckIdx];
        document.getElementById("dm-current-deck-title").innerText = deck.title;
        const listEl = document.getElementById("dm-card-list");
        listEl.innerHTML = "";
        deck.cards.forEach((card) => {
          if (card.isHidden) return;
          listEl.appendChild(createCardItem(card));
        });
      }
      function renderTrashBin() {
        const listEl = document.getElementById("dm-trash-list");
        listEl.innerHTML = "";
        let found = false;
        availableDecks.forEach((deck) => {
          deck.cards.forEach((card) => {
            const override = window.UserDB.getCardOverride(card.id);
            const isEdited =
              override && (override.question || override.explanation);
            if (card.isHidden || isEdited) {
              found = true;
              const el = createCardItem(card, true);
              listEl.appendChild(el);
            }
          });
        });
        if (!found)
          listEl.innerHTML =
            '<div style="text-align:center; color:#666; margin-top:50px;">Th√πng r√°c tr·ªëng!</div>';
      }
      function createCardItem(card, isTrashMode = false) {
        const div = document.createElement("div");
        div.className = `dm-card-item ${card.isHidden ? "hidden-card" : ""}`;
        const override = window.UserDB.getCardOverride(card.id);
        const isEdited =
          override && (override.question || override.explanation);
        if (isEdited) div.classList.add("edited-card");
        div.innerHTML = `<div style="flex:1; padding-right:10px;"><div style="font-weight:bold; font-size:0.9rem; color: var(--accent-color);">ID: ${
          card.id
        } ${isEdited ? "(ƒê√£ s·ª≠a)" : ""} ${
          card.isHidden ? "(ƒê√£ ·∫©n)" : ""
        }</div><div>${card.question
          .replace(/<br>/g, "\n")
          .replace(/<[^>]*>/g, "")
          .substring(0, 60)}...</div></div><div class="dm-card-actions">${
          !isTrashMode
            ? `<button class="dm-action-btn btn-edit" onclick="dmEditCard('${card.id}')" title="S·ª≠a"><i class="fas fa-pen"></i></button><button class="dm-action-btn btn-reset" onclick="dmResetCard('${card.id}')" title="Reset FSRS"><i class="fas fa-history"></i></button><button class="dm-action-btn btn-hide" onclick="dmHideCard('${card.id}')" title="·∫®n th·∫ª"><i class="fas fa-eye-slash"></i></button>`
            : `<button class="dm-action-btn btn-restore" onclick="dmRestoreCard('${card.id}')" title="Kh√¥i ph·ª•c g·ªëc"><i class="fas fa-undo"></i></button>`
        }</div>`;
        return div;
      }
      function findCardById(id) {
        for (let d of availableDecks) {
          for (let c of d.cards) {
            if (c.id === id) return c;
          }
        }
        return null;
      }
      function dmHideCard(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ·∫©n th·∫ª n√†y kh·ªèi l·ªãch h·ªçc?")) return;
        const card = findCardById(id);
        if (card) {
          card.isHidden = true;
          window.UserDB.saveCardOverride(id, { isHidden: true });
          showDeckList(currentDMDeckIdx);
        }
      }
      function dmResetCard(id) {
        if (!confirm("Reset ti·∫øn ƒë·ªô h·ªçc c·ªßa th·∫ª n√†y v·ªÅ 0?")) return;
        window.UserDB.saveCardOverride(id, { fsrs: null });
        alert("ƒê√£ reset ti·∫øn ƒë·ªô th·∫ª!");
      }
      function dmEditCard(id) {
        const card = findCardById(id);
        if (card) openEditModalForCard(card);
      }
      function dmRestoreCard(id) {
        if (
          !confirm(
            "Kh√¥i ph·ª•c th·∫ª v·ªÅ tr·∫°ng th√°i g·ªëc (B·ªè ·∫©n v√† n·ªôi dung ƒë√£ s·ª≠a)?"
          )
        )
          return;
        const card = findCardById(id);
        if (card) {
          window.UserDB.restoreCard(id);
          card.isHidden = false;
          alert("ƒê√£ kh√¥i ph·ª•c!");
          renderTrashBin();
        }
      }
      function toggleSettingsView() {
        const stats = document.getElementById("view-stats");
        const settings = document.getElementById("view-settings");
        if (settings.classList.contains("hidden")) {
          stats.classList.add("hidden");
          settings.classList.remove("hidden");
          settings.style.display = "block";
          stats.style.display = "none";
        } else {
          stats.classList.remove("hidden");
          settings.classList.add("hidden");
          settings.style.display = "none";
          stats.style.display = "grid";
        }
        if (document.getElementById("theme-select"))
          document.getElementById("theme-select").value =
            localStorage.getItem("app_theme") || "galaxy";
      }
      function changeTheme(t) {
        document.body.setAttribute("data-theme", t);
        localStorage.setItem("app_theme", t);
        if (window.UserDB) window.UserDB.setTheme(t);
        if (t === "galaxy") location.reload();
      }
      function confirmResetData() {
        if (confirm("C·∫¢NH B√ÅO: X√≥a to√†n b·ªô d·ªØ li·ªáu?")) {
          if (window.UserDB) window.UserDB.resetAllData();
        }
      }
      function openEditModalForCurrent() {
        openEditModalForCard(currentCard);
      }
      function openEditModalForCard(card) {
        cardToEdit = card;
        document.getElementById("edit-modal").classList.add("modal-active");
        document.getElementById("edit-q").value = card.question
          .replace(/<br>/g, "\n")
          .replace(/<[^>]*>/g, "");
        /* Simple strip for edit */ document.getElementById("edit-a").value =
          card.answer.replace(/<br>/g, "\n").replace(/<[^>]*>/g, "");
      }
      function closeEditModal() {
        document.getElementById("edit-modal").classList.remove("modal-active");
      }

      /* --- SAVE EDIT (FIXED: INNERHTML FOR LIVE UPDATE) --- */
      function saveCardEdit() {
        if (cardToEdit) {
          const newQ = document.getElementById("edit-q").value;
          const newA = document.getElementById("edit-a").value;
          cardToEdit.question = newQ;
          cardToEdit.answer = newA;
          window.UserDB.saveCardOverride(cardToEdit.id, {
            question: newQ,
            answer: newA,
          });
          if (cardToEdit === currentCard) {
            document.getElementById("q-text").innerHTML = cardToEdit.question;
            if (
              document.getElementById("q-answer-area").style.display === "block"
            ) {
              document.getElementById("q-answer-area").innerHTML =
                cardToEdit.answer;
            }
          }
          if (
            document
              .getElementById("screen-data-manager")
              .classList.contains("active")
          ) {
            if (currentDMDeckIdx !== -1) showDeckList(currentDMDeckIdx);
          }
        }
        closeEditModal();
      }

      function startGalaxyAnim() {
        setInterval(() => {
          const s = document.createElement("div");
          s.className = "shooting-star";
          s.style.top = Math.random() * 70 + "%";
          s.style.left = Math.random() * 80 + "%";
          document.getElementById("galaxy-bg-layer").appendChild(s);
          setTimeout(() => s.remove(), 2000);
        }, 2000);
      }
      function initFloatingAvatar() {
        const avatar = document.getElementById("floating-avatar");
        let isDragging = false;
        let hasMoved = false;
        let startX, startY, initialLeft, initialTop;
        avatar.addEventListener("mousedown", dragStart);
        avatar.addEventListener("touchstart", dragStart, { passive: false });
        function dragStart(e) {
          if (e.type === "touchstart") {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
          } else {
            startX = e.clientX;
            startY = e.clientY;
          }
          const rect = avatar.getBoundingClientRect();
          initialLeft = rect.left;
          initialTop = rect.top;
          hasMoved = false;
          isDragging = true;
          if (e.type === "touchstart") {
            document.addEventListener("touchmove", dragMove, {
              passive: false,
            });
            document.addEventListener("touchend", dragEnd);
          } else {
            document.addEventListener("mousemove", dragMove);
            document.addEventListener("mouseup", dragEnd);
          }
        }
        function dragMove(e) {
          if (!isDragging) return;
          let clientX, clientY;
          if (e.type === "touchmove") {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
            e.preventDefault();
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }
          const dx = clientX - startX;
          const dy = clientY - startY;
          if (Math.abs(dx) > 5 || Math.abs(dy) > 5) hasMoved = true;
          avatar.style.left = `${initialLeft + dx}px`;
          avatar.style.top = `${initialTop + dy}px`;
          avatar.style.right = "auto";
          avatar.style.bottom = "auto";
        }
        function dragEnd(e) {
          isDragging = false;
          if (e.type === "touchend") {
            document.removeEventListener("touchmove", dragMove);
            document.removeEventListener("touchend", dragEnd);
          } else {
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", dragEnd);
          }
          if (!hasMoved) openProfile();
        }
      }
      let pomoTimer;
      let isRunning = false;
      let timeLeft = 25 * 60;
      function loadPomoState() {
        const stateJSON = localStorage.getItem(POMO_STATE_KEY);
        if (stateJSON) {
          const state = JSON.parse(stateJSON);
          if (state.isRunning) {
            const now = Date.now();
            const secondsRemaining = Math.round((state.endTime - now) / 1000);
            if (secondsRemaining > 0) {
              timeLeft = secondsRemaining;
              isRunning = true;
              startTimerInterval();
            } else {
              timeLeft = 0;
              isRunning = false;
              localStorage.removeItem(POMO_STATE_KEY);
            }
          } else {
            timeLeft = state.remaining;
            isRunning = false;
          }
        } else {
          if (window.UserDB) timeLeft = window.UserDB.data.pomodoro.workTime;
        }
      }
      function savePomoState(running) {
        const state = {
          isRunning: running,
          endTime: running ? Date.now() + timeLeft * 1000 : null,
          remaining: timeLeft,
        };
        localStorage.setItem(POMO_STATE_KEY, JSON.stringify(state));
      }
      function startTimerInterval() {
        if (pomoTimer) clearInterval(pomoTimer);
        pomoTimer = setInterval(() => {
          if (timeLeft > 0) {
            timeLeft--;
            updatePomoDisplay();
          } else {
            finishPomo();
          }
        }, 1000);
      }
      function initIOSPickers() {
        generatePickerItems("pomo-min-scroll", 60, 25);
        generatePickerItems("pomo-sec-scroll", 60, 0);
        const elMin = document.getElementById("pomo-min-scroll");
        const elSec = document.getElementById("pomo-sec-scroll");
        if (elMin) elMin.addEventListener("scroll", updateTimeFromPicker);
        if (elSec) elSec.addEventListener("scroll", updateTimeFromPicker);
      }
      function generatePickerItems(id, count, selected) {
        const container = document.getElementById(id);
        if (!container) return;
        while (container.children.length > 2)
          container.removeChild(container.children[1]);
        for (let i = 0; i < count; i++) {
          const div = document.createElement("div");
          div.className = "picker-item";
          div.innerText = i.toString().padStart(2, "0");
          container.insertBefore(div, container.lastElementChild);
        }
        container.scrollTop = selected * 40;
      }
      function updatePickerPosition() {
        const min = Math.floor(timeLeft / 60);
        const sec = timeLeft % 60;
        const elMin = document.getElementById("pomo-min-scroll");
        const elSec = document.getElementById("pomo-sec-scroll");
        if (elMin) elMin.scrollTop = min * 40;
        if (elSec) elSec.scrollTop = sec * 40;
      }
      function updateTimeFromPicker() {
        if (isRunning) return;
        const min = Math.round(
          document.getElementById("pomo-min-scroll").scrollTop / 40
        );
        const sec = Math.round(
          document.getElementById("pomo-sec-scroll").scrollTop / 40
        );
        timeLeft = min * 60 + sec;
        if (window.UserDB) {
          window.UserDB.data.pomodoro.workTime = timeLeft;
          window.UserDB.save();
        }
        localStorage.removeItem(POMO_STATE_KEY);
        updatePomoDisplay();
        document.getElementById("pomo-toggle").innerText = "B·∫Øt ƒë·∫ßu";
      }
      function togglePomo() {
        if (isRunning) {
          clearInterval(pomoTimer);
          isRunning = false;
          savePomoState(false);
          document.getElementById("pomo-toggle").innerText = "Ti·∫øp t·ª•c";
          document.getElementById("pomo-picker-ui").style.pointerEvents =
            "auto";
          document.getElementById("pomo-picker-ui").style.opacity = "1";
          updatePickerPosition();
        } else {
          if (timeLeft <= 0) return alert("H√£y ch·ªçn th·ªùi gian!");
          isRunning = true;
          savePomoState(true);
          document.getElementById("pomo-toggle").innerText = "T·∫°m d·ª´ng";
          document.getElementById("pomo-picker-ui").style.pointerEvents =
            "none";
          document.getElementById("pomo-picker-ui").style.opacity = "0.5";
          startTimerInterval();
        }
      }
      function finishPomo() {
        clearInterval(pomoTimer);
        isRunning = false;
        localStorage.removeItem(POMO_STATE_KEY);
        alert("Ho√†n th√†nh!");
        if (window.UserDB) {
          const workTime = window.UserDB.data.pomodoro.workTime;
          if (workTime >= 25 * 60) {
            window.UserDB.addSeeds(Math.floor(workTime / (25 * 60)));
            window.UserDB.completePomodoroQuest();
          }
        }
        resetPomo();
        updateProfileUI();
      }
      function resetPomo() {
        clearInterval(pomoTimer);
        isRunning = false;
        localStorage.removeItem(POMO_STATE_KEY);
        if (window.UserDB) timeLeft = window.UserDB.data.pomodoro.workTime;
        document.getElementById("pomo-toggle").innerText = "B·∫Øt ƒë·∫ßu";
        document.getElementById("pomo-picker-ui").style.pointerEvents = "auto";
        document.getElementById("pomo-picker-ui").style.opacity = "1";
        updatePomoDisplay();
        updatePickerPosition();
      }
      function updatePomoDisplay() {
        const el = document.getElementById("pomo-timer");
        if (!el) return;
        const m = Math.floor(timeLeft / 60)
          .toString()
          .padStart(2, "0");
        const s = (timeLeft % 60).toString().padStart(2, "0");
        el.innerText = `${m}:${s}`;
      }
    </script>
  </body>
</html>
